# AIGE 项目开发设计文档

## 项目概述

AIGE（AI Game Engine）是一个基于AI驱动的文字冒险游戏引擎，专门用于创建沉浸式的修仙类角色扮演游戏。项目采用前后端分离架构，结合多种AI服务提供商，实现动态剧情生成和流式交互体验。

## 技术架构

### 整体架构图
```
┌─────────────────┐    HTTP/WebSocket    ┌─────────────────┐
│   前端 (Vue3)   │ ←──────────────────→ │  后端 (Go/Gin)  │
│  - 用户界面     │                      │  - API服务      │
│  - 游戏交互     │                      │  - 游戏引擎     │
│  - 状态管理     │                      │  - AI集成       │
└─────────────────┘                      └─────────────────┘
                                                  │
                                                  ▼
                                         ┌─────────────────┐
                                         │ SQLite 数据库   │
                                         │  - 用户数据     │
                                         │  - 游戏存档     │
                                         │  - 系统配置     │
                                         └─────────────────┘
                                                  │
                                                  ▼
                                         ┌─────────────────┐
                                         │  游戏MOD系统    │
                                         │  - 修仙模组     │
                                         │  - 游戏配置     │
                                         │  - 提示词       │
                                         └─────────────────┘
                                                  │
                                                  ▼
                                         ┌─────────────────┐
                                         │   AI服务商      │
                                         │  - OpenAI       │
                                         │  - Anthropic    │
                                         │  - Google       │
                                         └─────────────────┘
```

## 前端架构 (frontend/)

### 技术栈
- **框架**: Vue 3 + TypeScript + Composition API
- **UI库**: Element Plus
- **状态管理**: Pinia
- **路由**: Vue Router 4
- **HTTP客户端**: Axios
- **构建工具**: Vite
- **Markdown渲染**: Marked

### 目录结构
```
frontend/
├── src/
│   ├── components/        # 组件
│   │   └── admin/        # 管理员组件
│   │       ├── Playground.vue      # 测试场
│   │       ├── ProviderManagement.vue  # AI提供商管理
│   │       ├── SystemSettings.vue  # 系统设置
│   │       ├── UserManagement.vue  # 用户管理
│   │       └── WelcomePage.vue     # 欢迎页
│   ├── router/           # 路由配置
│   ├── services/         # API服务
│   ├── stores/           # Pinia状态管理
│   ├── types/            # TypeScript类型定义
│   ├── utils/            # 工具函数
│   └── views/            # 页面组件
│       ├── AdminView.vue     # 管理后台
│       ├── ChatView.vue      # 聊天界面（已废弃）
│       ├── GameView.vue      # 游戏主界面
│       └── LoginView.vue     # 登录页面
├── package.json
└── vite.config.ts
```

### 核心功能模块

#### 1. 认证系统
- JWT令牌认证
- 用户角色权限控制
- 路由守卫保护

#### 2. 游戏界面 (GameView.vue)
- 修仙游戏主界面
- 实时流式对话
- 游戏状态展示
- 左侧栏系统管理

#### 3. 管理后台 (AdminView.vue)
- AI提供商配置
- 用户管理
- 系统设置
- 游戏测试场

#### 4. 状态管理 (Pinia Stores)
- **auth.ts**: 用户认证状态
- **chat.ts**: 聊天/游戏状态  
- **admin.ts**: 管理员功能状态

## 后端架构 (backend/)

### 技术栈
- **语言**: Go 1.24
- **Web框架**: Gin
- **ORM**: GORM
- **数据库**: SQLite
- **认证**: JWT
- **跨域**: gin-contrib/cors
- **WebSocket**: gorilla/websocket

### 目录结构
```
backend/
├── config/              # 配置管理
│   └── database.go     # 数据库配置
├── controllers/         # 控制器层
│   ├── admin.go        # 管理员控制器
│   ├── ai.go           # AI服务控制器
│   ├── auth.go         # 认证控制器
│   ├── chat.go         # 聊天控制器
│   ├── config.go       # 配置控制器
│   ├── game.go         # 游戏控制器
│   ├── model.go        # 模型控制器
│   └── provider.go     # 提供商控制器
├── game_engine/         # 游戏引擎
│   ├── compression_manager.go  # 对话压缩管理
│   ├── game_controller.go     # 游戏逻辑控制
│   ├── mod_loader.go          # MOD加载器
│   └── state_manager.go       # 状态管理器
├── middleware/          # 中间件
│   └── auth.go         # 认证中间件
├── models/              # 数据模型
│   ├── migrate.go      # 数据库迁移
│   └── models.go       # 数据模型定义
├── routes/              # 路由配置
│   └── routes.go       # 路由定义
├── services/            # 服务层
│   ├── ai_client.go    # AI客户端服务
│   └── model_fetcher.go # 模型获取服务
├── utils/               # 工具函数
│   └── auth.go         # 认证工具
├── go.mod
└── main.go             # 程序入口
```

### 核心功能模块

#### 1. 游戏引擎 (game_engine/)
**GameController**: 游戏逻辑控制核心
- 初始化游戏会话
- 处理玩家行动
- 管理AI交互
- 支持流式响应和二阶段判定

**StateManager**: 游戏状态管理
- 会话存储和检索  
- 自动保存机制
- 每日重置逻辑
- 数据库持久化

**CompressionManager**: 对话历史压缩
- 智能压缩长对话历史
- 保持游戏上下文连贯性
- 优化AI调用成本

**ModLoader**: 模组加载系统
- 动态加载游戏MOD
- 配置文件解析
- 提示词管理

#### 2. AI服务集成 (services/)
**AIClient**: 多AI提供商支持
- OpenAI API集成
- Anthropic Claude集成  
- Google Gemini集成
- 流式响应处理
- 统一调用接口

#### 3. 数据模型 (models/)
**核心实体**:
- **User**: 用户账户信息
- **ChatMessage**: 聊天消息记录
- **Provider**: AI服务提供商配置
- **Model**: AI模型配置
- **GameSave**: 游戏存档数据
- **SystemConfig**: 系统配置

## 游戏MOD系统

### MOD结构
```
mods/
└── xiuxian/            # 修仙模组
    ├── config.json     # 游戏配置
    └── prompts/        # 提示词文件
        ├── cheat_check.txt    # 作弊检测
        ├── game_master.txt    # 游戏主持人
        └── start_game.txt     # 游戏开始
```

### 修仙游戏特性
- **境界体系**: 炼气期→筑基期→结丹期→元婴期→化神期
- **宗门系统**: 8大宗门各具特色玩法
- **资源管理**: 灵石、丹药、法宝、修为
- **社交系统**: 道侣、师门、声望关系网
- **基建系统**: 洞府、药园经营
- **成就系统**: 16种结局分类

### 游戏机制
- **十次机缘**: 每日10次游戏机会
- **二阶段判定**: AI请求判定→执行→基于结果继续
- **压缩机制**: 智能压缩对话历史保持上下文
- **流式叙事**: 实时生成游戏剧情
- **动态结局**: 根据玩家行为动态评估结局

## 核心技术实现

### 1. 流式AI对话
```go
// 流式处理AI响应
func (gc *GameController) ProcessActionStream(
    playerID, modID, action string,
    streamCallback StreamCallback,
    rollCallback RollEventCallback,
    secondStageCallback StreamCallback
) error
```

### 2. 状态持久化
- 内存缓存 + 数据库持久化
- 自动保存机制
- 事务性状态更新

### 3. 用户认证
- JWT令牌机制
- 角色权限控制（普通用户/管理员）
- 中间件保护敏感接口

### 4. 跨域配置
```go
r.Use(cors.New(cors.Config{
    AllowOrigins:     []string{"http://localhost:8000", "http://localhost:5173"},
    AllowMethods:     []string{"GET", "POST", "PUT", "DELETE", "OPTIONS"},
    AllowHeaders:     []string{"Origin", "Content-Type", "Accept", "Authorization"},
    AllowCredentials: true,
}))
```

## 部署架构

### 开发环境
- 前端: `npm run dev` (Vite开发服务器)
- 后端: `go run main.go` (端口8182)
- 数据库: SQLite文件数据库

### 生产环境建议
- 前端: 静态资源部署 (CDN + Nginx)
- 后端: Docker容器化部署
- 数据库: 可升级至MySQL/PostgreSQL
- 负载均衡: Nginx反向代理

## API设计

### RESTful风格接口
```
/api/v1/
├── auth/           # 认证相关
│   ├── login       # 用户登录
│   ├── register    # 用户注册
│   └── profile     # 获取用户信息
├── game/           # 游戏相关
│   ├── session     # 游戏会话管理
│   ├── action      # 玩家行动处理
│   └── state       # 游戏状态查询
├── admin/          # 管理功能
│   ├── users       # 用户管理
│   ├── providers   # AI提供商管理
│   └── models      # AI模型管理
└── config/         # 系统配置
```

### WebSocket接口
- `/ws/game`: 游戏实时交互
- 支持流式叙事推送
- 支持判定事件通知

## 数据流向

### 游戏交互流程
```
用户输入 → 前端GameView → WebSocket → 后端GameController 
→ AI服务 → 流式响应 → 状态更新 → 数据库保存 → 前端展示
```

### 状态管理流程  
```
游戏状态变更 → StateManager → 内存缓存 → 数据库持久化
自动保存机制 → 定期刷新 → 每日重置逻辑
```

## 安全考虑

### 1. 认证授权
- JWT令牌过期机制
- 角色权限分离
- 敏感操作二次验证

### 2. 数据安全
- SQL注入防护（GORM参数化查询）
- XSS防护（前端输入过滤）
- API访问限频

### 3. 业务安全
- 游戏状态完整性校验
- 作弊行为检测机制
- 资源消耗监控

## 性能优化

### 1. 前端优化
- 组件懒加载
- 虚拟列表渲染
- 状态缓存管理
- 资源压缩打包

### 2. 后端优化
- 数据库连接池
- 内存状态缓存
- 异步处理队列
- 压缩算法优化

### 3. AI调用优化
- 对话历史压缩
- 模型选择策略
- 请求重试机制
- 响应缓存策略

## 扩展性设计

### 1. MOD系统扩展
- 插件化架构支持
- 动态配置加载
- 自定义提示词
- 游戏规则自定义

### 2. AI模型扩展
- 新AI提供商接入
- 多模型并行调用
- 模型性能监控
- 成本控制管理

### 3. 功能模块扩展
- 多人游戏支持
- 实时对战功能  
- 社区分享系统
- 成就排行榜

## 监控与日志

### 1. 应用监控
- API响应时间监控
- 错误率统计分析
- 用户行为分析
- 资源使用监控

### 2. 业务监控
- 游戏会话统计
- AI调用成本分析
- 用户留存分析
- 功能使用热图

### 3. 日志管理
- 结构化日志输出
- 日志级别分层
- 错误追踪链路
- 审计日志记录

## 开发规范

### 1. 代码规范
- Go: gofmt + golint
- TypeScript: ESLint + Prettier
- Git提交规范
- 代码审查流程

### 2. 测试策略
- 单元测试覆盖
- 集成测试验证
- E2E测试保障
- 性能测试监控

### 3. 文档维护
- API文档同步更新
- 架构决策记录
- 部署操作手册
- 故障排查指南

## 技术债务与改进建议

### 1. 当前技术债务
- 前端组件复用度不高
- 错误处理机制不完善
- 单元测试覆盖不足
- 日志记录不够详细

### 2. 改进建议
- 重构公共组件库
- 完善错误处理和用户提示
- 增加测试用例覆盖
- 实现结构化日志系统
- 添加性能监控指标
- 优化AI调用成本

## 总结

AIGE项目是一个技术先进、架构合理的AI驱动游戏引擎。项目采用现代化的技术栈，实现了前后端分离、模块化设计、可扩展架构。核心的游戏引擎具备智能对话压缩、流式交互、状态持久化等先进特性，为用户提供了沉浸式的修仙游戏体验。

项目具备良好的扩展性和维护性，可以支持多种游戏类型和AI模型接入，为未来的功能扩展和业务发展提供了坚实的技术基础。